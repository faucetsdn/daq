#!/bin/bash -e

if [ -z "$DAQ_TEST" ]; then
    echo DAQ_TEST not defined.
    false
fi

if [ -z "$DAQ_RESULT" ]; then
    echo DAQ_RESULT not defined.
    false
fi

function delay_finish {
    # Travis doesn't always wait for buffer to flush on exit, so give some time.
    sleep 10
}

if [ -n "$TRAVIS" ]; then
    trap delay_finish EXIT
fi

ROOT=$(realpath $(dirname $0)/..)
cd $ROOT

# Out with the old, in with the new (use faucet instead).
sudo /etc/init.d/openvswitch-controller stop || true

echo -n "Last DAQ commit "
git log -n 1 --pretty=format:"%h - %an, %ar : %s" || true
echo

if [ -d faucet ]; then
    echo -n "Last FAUCET commit "
    (cd $FAUCET; git log -n 1 --pretty=format:"%h - %an, %ar : %s" || true)
    echo
fi

if [ -d inst ]; then
    echo Directory inst/ exists, clean out before test run.
    false
fi

if [ -d local ]; then
    echo Directory local/ exists, clean out before test run.
    false
fi

mkdir -p local inst

echo I am g`whoami`

export TEST_RESULTS=inst/test_results.log

echo Running test script $DAQ_TEST
sudo TEST_RESULTS=$TEST_RESULTS $DAQ_TEST
echo
echo Test results $TEST_RESULTS
cat $TEST_RESULTS
echo
echo Comparing results against $DAQ_RESULT
diff $TEST_RESULTS $DAQ_RESULT
echo
echo Done with tests.
