#!/bin/bash -e
#
# Run the DAQ testing in a continuous loop,
# with shunting log output to rotating files.
#
# Some common options (ordered):
#   debug:  Set daq and mininet loglevels to 'debug'
#   image:  Use cmd/run instead of cmd/exrun.
#   latest: Passed to runner, will use latest daq image (not versioned).
#

ROOT=$(realpath $(dirname $0)/..)

cd $ROOT
auto_run=cmd/run
auto_args=
auto_log=inst/exrun-

version=$(cat misc/RELEASE_VERSION)
PIDFILE=inst/daq.pid
SYSCONF=local/system.conf

if [ -f $SYSCONF ]; then
    echo Loading config from $SYSCONF
    source $SYSCONF
fi

if [ "$1" == debug ]; then
    auto_args+=" daq_loglevel=debug"
    auto_args+=" mininet_loglevel=debug"
    shift
fi

if [ "$1" == image ]; then
    auto_cmd=cmd/run
    shift
fi

if [ "$1" == local ]; then
    auto_cmd=cmd/exrun
    shift
fi

if [ "$1" == latest ]; then
    auto_args="latest $auto_args"
    version=latest
    shift
fi

if [ $# -gt 0 ]; then
    echo Unknown command line option $1.
    false
fi

if [ -f $PIDFILE ]; then
    pid=$(< $PIDFILE)
    if [ -d /proc/$pid ]; then
        echo Process $pid from $PIDFILE still running.
        false
    fi
fi

found=n
docker ps | fgrep daq- && found=y || true
if [ "$found" = y ]; then
    echo Lingering docker containers found.
    false
fi

sudo rm -rf inst
mkdir -p inst

echo Running version $version
echo Running $auto_run $auto_args
echo Logs in $ROOT/${auto_log}\*.log

nohup $auto_run "$@" $auto_args 2>&1 | \
    rotatelogs -t -c ${auto_log}%I.log 3600 &
