#!/bin/bash -e
#
# Setup the (runtime) system by building DAQ, as necessary.
# DAQ_BUILD mode is normally specified by the environment (e.g. travis).
# 

function delay_finish {
    # Travis doesn't always wait for buffer to flush on exit, so give some time.
    sleep 10
}

if [ -n "$TRAVIS" ]; then
    trap delay_finish EXIT
fi

echo -n "DAQ commit "
git log -n 1 --pretty=format:"%h - %an, %ar : %s" || true
echo

echo -n "Last FAUCET commit "
(cd faucet; git log -n 1 --pretty=format:"%h - %an, %ar : %s" || true)
echo

docker --version

if ! docker images > /dev/null; then
    echo
    echo Docker execution failed, is the docker group setup?
    echo If this is the first time, try logging out and log back in again.
    false
fi

cmd/build pull inline < /dev/null

# Show the results.
docker images

# Clean this out b/c it'll have lots of junk in it.
rm -rf build
