#!/bin/bash -e

set -e

if [ -n "$TARGET" ] && [ -n "$VERSION" ]; then
    found=yes
    echo Checking for existing image $TARGET...
    curl --silent -f -lSL https://index.docker.io/v1/repositories/$TARGET/tags/$VERSION > /dev/null 2>&1 || found=no
    if [ $found == yes ]; then
	echo Docker image $TARGET:$VERSION already exists.
	false
    fi

    if [ -n "$DOCKER_USERNAME" ] && [ -n "$DOCKER_PASSWORD" ]; then
        echo Logging into docker as $DOCKER_USERNAME...
        echo "$DOCKER_PASSWORD" | \
            docker login -u "$DOCKER_USERNAME" --password-stdin
    fi

    echo Pushing $TARGET
    docker push $TARGET:$VERSION
    echo Done with push.
else
    echo Skipping push because TRAGET and VERSION are not set.
fi
