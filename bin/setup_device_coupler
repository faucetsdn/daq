#!/bin/bash -e

ROOT=$(realpath $(dirname $0)/..)
echo ROOT is $ROOT

$ROOT/bin/build_dev_coupler_container
$ROOT/bin/start_dev_coupler_container

for i in 1 2 3; do
    $ROOT/cmd/faux $i
    sudo ip link set faux-$i up
done

PYTHONPATH=PYTHONPATH:$ROOT python3 device_coupler/simulate_access_switch.py --bridge br0 --devices 3 --trunk-iface trunk0
pid=$(docker inspect --format="{{ .State.Pid  }}" dev_coupler_box)
sudo ip link set trunk0 netns $pid

docker exec dev_coupler_box ip link set trunk0 up
docker exec dev_coupler_box python3 device_coupler/network_helper.py
