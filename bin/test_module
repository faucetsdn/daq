#!/bin/bash -ex

if [ -z "$1" ]; then
    echo $0 module test-args
    false
fi

if [ "$1" == -b ]; then
    build=y
    shift
fi

module=$1
shift

ROOT=$(realpath $(dirname $0)/..)
cd $ROOT

image=daqf/test_$module
container=test_$module
docker_args=
net_opt=--net=none
module_dir=$ROOT/inst/module/$module
rm -rf $module_dir

if [ -n "$build" ]; then
    DAQ_TARGETS=faux,$container bin/docker_build build-all
fi

cmd/faux @$module xdhcp $@
faux_iface=faux-$module
faux_ip=10.20.0.5

mkdir -p $module_dir/scans
echo Capturing fake startup.pcap...
sudo timeout 3s tcpdump -eni $faux_iface -Z root -w $module_dir/scans/startup.pcap || true

docker_args+=" --env TARGET_IP=$faux_ip"
docker_args+=" -v $module_dir/scans:/scans"

docker rm -f $container || true
cid=$(
    docker run -d --privileged --name $container --hostname $container \
	   --entrypoint env $net_opt $docker_args $image \
	   tail -f /dev/null
    )
pid=$(docker inspect --format="{{ .State.Pid }}" $cid)
echo Docker $image $container $cid $pid

sleep 5

echo %%% Docker container logs
docker logs $container
