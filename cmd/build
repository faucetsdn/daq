#!/bin/bash -e

# Set this so docker build will fail even though piped through tee.
set -o pipefail

#cmd/build
#cmd/build inline
#cmd/build push
#cmd/build pull
#cmd/build pull inline

ROOT=$(dirname $0)/..

inline=
copydirs="bin cmd misc faucet mininet docker daq subset"
DOCKER_IMAGE_LIST=misc/docker_images.txt
pulled=

cd $ROOT
source misc/config_base.sh

if [ "$1" == push ]; then
    cat $DOCKER_IMAGE_LIST | while read image hash other; do
        found=$(docker images $image | awk '{print $3}' | grep $hash) || echo ""
        if [ -z "$found" ]; then
            echo $image:$hash not found locally...
            continue
        fi
        echo Push $image:$hash to dockerhub...
        TARGET="$image" VERSION="$hash" ./bin/docker_push  
    done 
    echo Done with docker build push.
    exit 0
elif [ "$1" == pull ]; then
    pulled=y
    cat $DOCKER_IMAGE_LIST | while read image hash other; do
        echo Pulling $image:$hash from dockerhub...
        (docker pull $image:$hash && found=y)|| echo "Could not pull $image:$hash."
        if [ -n "$found" ]; then
            docker tag $image:$hash $image:latest
        fi
    done 
    shift
fi

if [ "$1" == inline ]; then
    inline="inline"
    shift
fi


local_version=$(cd faucet; git rev-list -n 1 HEAD)
if [ "$1" == -f ]; then
    echo Forcing misc/FAUCET_VERSION to $local_version
    echo $local_version > misc/FAUCET_VERSION
    shift
fi

target_version=$(cat misc/FAUCET_VERSION)
target_commit=$(cd faucet; git rev-parse $target_version)
if [ "$target_commit" != "$local_version" ]; then
    echo Local faucet commit is at: $local_version
    echo Mismatch with misc/FAUCET_VERSION: $target_version
    echo Try 'bin/clean_dev && bin/setup_dev' to reset.
    false
fi

CHECK_EXISTING=$pulled bin/docker_build $inline

echo Updating $DOCKER_IMAGE_LIST...
docker images | sort | fgrep daqf/ | fgrep latest | while read image tag hash other; do
    echo $image $hash >> $DOCKER_IMAGE_LIST
done

echo Updating .build_hash
bin/build_hash write
mv -f .build_files .build_built
