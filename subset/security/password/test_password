#!/bin/bash -e

# Entry point for the security.admin.password test - Runs the test on all protocols <http|https|telnet|ssh> in parallel
# and writes the output into reports file to be used by DAQ.
# Usage: Run with no arguments, relies on environment variables exported by DAQ e.g. $TARGET_IP/$TARGET_MAC

source reporting.sh

MODULE_CONFIG="/tmp/module_config.json"
HTTP="HTTP"
HTTPS="HTTPS"
TELNET="Telnet"
SSH="SSH"
DICTIONARY=""
REPORT=reports/report.txt

# Does module config json specify using the faux dictionary?
# $1 Module config path
function module_config_use_faux_dictionary_is_true() {
  cat $1 | jq '.modules.password.use_faux_dictionary' | grep "true"
}

# Makes the log files in the tmp folder. These files hold the output of the run_password_test_for_protocol command.
function make_log_files() {
  touch /tmp/http_report.txt
  touch /tmp/https_report.txt
  touch /tmp/telnet_report.txt
  touch /tmp/ssh_report.txt
}

# Sets test description for a given protocol.
# $1 Target protocol
function set_test_desc() {
  TEST_DESC="Verify all device manufacturer default passwords are changed for protocol: $1, and new passwords are set."
}

# Runs the password test on all protocols in parallel, writes output to the log files.
# $1 Target IP
# $2 Dictionary
function run_password_test_on_all_protocols () {
  ./run_password_test_for_protocol $1 http 80 &> /tmp/http_report.txt $2 &
  ./run_password_test_for_protocol $1 https 443 &> /tmp/https_report.txt $2 &
  ./run_password_test_for_protocol $1 telnet 23 &> /tmp/telnet_report.txt $2 &
  ./run_password_test_for_protocol $1 ssh 22 &> /tmp/ssh_report.txt $2 &
  wait
}

if [ -n "$TARGET_IP" ]; then

  if module_config_use_faux_dictionary_is_true $MODULE_CONFIG; then
    DICTIONARY="resources/faux_dictionary.txt"
  else
    DICTIONARY="resources/dictionary.txt"
    ./create_brute_force_dictionary
  fi

  run_password_test_on_all_protocols $TARGET_IP $DICTIONARY

  make_log_files

  set_test_desc $HTTP

  write_out_result $REPORT \
    "security.passwords.http" \
    "$TEST_DESC" \
    "$(cat /tmp/http_report.txt)" \
    "$(cat reports/http_result.txt)"

  set_test_desc $HTTPS

  write_out_result $REPORT \
    "security.passwords.https" \
    "$TEST_DESC" \
    "$(cat /tmp/https_report.txt)" \
    "$(cat reports/https_result.txt)"

  set_test_desc $TELNET

  write_out_result $REPORT \
    "security.passwords.telnet" \
    "$TEST_DESC" \
    "$(cat /tmp/telnet_report.txt)" \
    "$(cat reports/telnet_result.txt)"

  set_test_desc $SSH

  write_out_result $REPORT \
    "security.passwords.ssh" \
    "$TEST_DESC" \
    "$(cat /tmp/ssh_report.txt)" \
    "$(cat reports/ssh_result.txt)"

  cp -r $REPORT /tmp/report.txt
else
  echo Problem with target IP, password test cannot continue. | tee /tmp/report.txt
fi
