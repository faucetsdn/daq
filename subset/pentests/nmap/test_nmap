#!/bin/bash -e

export TEST_ROOT='.'
export TARGET_IP='localhost'

source $TEST_ROOT/reporting.sh
CONFIG=$TEST_ROOT/config/device/module_config.json
REPORT=$TEST_ROOT/tmp/report.txt

REPORT_NMAP=$TEST_ROOT/tmp/report_nmap.txt
REPORT_HTTP=$TEST_ROOT/tmp/report_http.txt

export CONFIG='module_config.json'

if [[ -f $CONFIG ]]; then
    services_scan=$(jq '.modules.nmap.services_scan' $CONFIG)
else
    services_scan=true
fi

if [[ $services_scan == true || $services_scan == null ]]; then
    # run full services scan
    echo "running full services scan"
    rm -f $REPORT_NMAP
    nmap -sV -p- --allports --version-intensity 2 -T5 -oX test.xml $TARGET_IP
    python3 test_nmap.py ./tmp/report_nmap.txt \
        module_config.json \
        test.xml
    
else   
    # run the legacy selected ports only scan
    echo "running legacy nmap scan"
    ./test_nmap_legacy
fi

# Run NMAP HTTP Test 
# (will skip if flag in module_config is set to disable it)
./test_nmap_http "$@"


cat $REPORT_NMAP $REPORT_HTTP > $REPORT

