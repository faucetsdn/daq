#!/bin/bash -e

source $TEST_ROOT/reporting.sh
CONFIG=$TEST_ROOT/config/device/module_config.json
REPORT=$TEST_ROOT/tmp/report.txt

REPORT_NMAP=$TEST_ROOT/tmp/report_nmap.txt
REPORT_HTTP=$TEST_ROOT/tmp/report_http.txt


if [[ -f $CONFIG ]]; then
    services_scan=$(jq '.modules.nmap.services_scan' $CONFIG)
else
    services_scan=true
fi

if [[ $services_scan == true || $services_scan == null ]]; then
    # run full services scan

    nmap -sV -p- --allports --version-intensity 7 -T4 $TARGET_IP
    nmap -sU -p 
else   
    # run the legacy selected ports only scan
    ./test_nmap_legacy "$@"
fi

# Run NMAP HTTP Test 
# (will skip if flag in module_config is set to disable it)
./test_nmap_http "$@"


cat $REPORT_NMAP $REPORT_HTTP > $REPORT

