#!/bin/bash -e

source $TEST_ROOT/reporting.sh

CONFIG=$TEST_ROOT/config/device/module_config.json
REPORT=$TEST_ROOT/tmp/report.txt

REPORT_NMAP=$TEST_ROOT/tmp/report_nmap.txt
REPORT_HTTP=$TEST_ROOT/tmp/report_http.txt

rm -f $REPORT_NMAP
touch $REPORT_NMAP

if [[ -f $CONFIG ]]; then
    services_scan=$(jq '.modules.nmap.services_scan' $CONFIG)
else
    services_scan=true
fi

if [[ $services_scan == true || $services_scan == null ]]; then
    # run full services scan
    echo "Running full services scan"

    TCP_SCAN_OUT=$TEST_ROOT/tmp/tcp_scan.xml
    UDP_SCAN_OUT=$TEST_ROOT/tmp/udp_scan.xml
   
    # Full port 
    nmap -sT -sV -Pn -v -p- --allports --version-intensity 7 -T4 -oX $TCP_SCAN_OUT $TARGET_IP
    
    # Minimum UDP ports for test_nmap.py 
    udp_ports='69,161,162,'

    # Read module_config for UDP ports so security.nmap.ports behavior
    # matches test_nmap_legacy
    if [[ -f $CONFIG ]]; then
        for k in $(jq -r '.servers.udp.ports | keys | .[]' $CONFIG); do
            udp_ports="$udp_ports$k,"
        done
    fi

    nmap -sU -sV -p $udp_ports -oX $UDP_SCAN_OUT $TARGET_IP

    python3 $TEST_ROOT/test_nmap.py $REPORT_NMAP $CONFIG \
        $TCP_SCAN_OUT $UDP_SCAN_OUT
    
else   
    # run the legacy selected ports only scan
    echo "running legacy nmap scan"
    $TEST_ROOT/test_nmap_legacy
fi

# Run NMAP HTTP Test 
# Logic for http_scan is within the test script itself
$TEST_ROOT/test_nmap_http "$@"

cat $REPORT_NMAP $REPORT_HTTP > $REPORT

