""" DAQ NMAP Module

This module only checks existing NMAP scan results therefore the scans
referenced must already have include the required ports, protocols, services
checked here, otherwise the output will be invalid.

NMAP must be run with the -oX <file> option

usage: test_nmap.py [-h] report_file module_config nmap_xml [nmap_xml ...]

positional arguments:
  report_file    Path to text file report output
  module_config  Path to module_config
  nmap_xml       Path to nmap XML output file

Limitations:
-   Currently ignores whether a service is tunnel via SSL.
    Ability to filter non SSL encrypted services can be future addition

"""

from __future__ import absolute_import
import argparse
import dataclasses
from nmap_test import NmapTest
from nmap_test_result import NmapTestResult

TCP = 'tcp'
UDP = 'udp'


def parse_command_line_args():
    parser = argparse.ArgumentParser()

    parser.add_argument('report_file', type=str,
                        help='Path to text file report output')

    parser.add_argument('module_config', type=str,
                        help='Path to module_config')

    parser.add_argument('nmap_xml', type=str, nargs='+',
                        help='Path to nmap XML output file')

    return parser.parse_args()


def test_smtp(nmap):
    name = 'security.services.smtp'
    description = 'Ensure SMTP servers running'
    result = nmap.test(protocol=TCP, ports=[25, 465, 587], services='smtp')
    nmap.write_report(name, description, result)


def test_telnet(nmap):
    name = 'security.services.telnet'
    description = 'Ensure Telnet servers not running'
    result = nmap.test(protocol=TCP, ports=23, services='telnet')
    nmap.write_report(name, description, result)


def test_pop(nmap):
    name = 'security.services.pop'
    description = 'Ensure POP servers not running'
    result = nmap.test(protocol=TCP, ports=[110, 993], services='pop3')
    nmap.write_report(name, description, result)


def test_imap(nmap):
    name = 'security.services.imap'
    description = 'Ensure IMAP servers not running'
    result = nmap.test(protocol=TCP, ports=[143, 993], services='imap')
    nmap.write_report(name, description, result)


def test_ftp(nmap):
    name = 'security.services.ftp'
    description = 'Ensure FTP servers not running'
    result = nmap.test(protocol=TCP, ports=[20, 21], services='ftp')
    nmap.write_report(name, description, result)


def test_tftp(nmap):
    name = 'security.services.tftp'
    description = 'Ensure TFTP server not running'
    result = nmap.test(protocol=UDP, ports=69)
    nmap.write_report(name, description, result)


def test_snmp(nmap):
    name = 'security.services.snmp'
    description = 'Ensure if SNMP is running it\'s SNMPv3'
    result = nmap.test(protocol=UDP, ports=[161, 162])

    # If port is open, check if v3
    # and overide the fail into a pass
    if result.result:
        if nmap.search_product(result, 'SNMPv3'):
            result = dataclasses.replace(
                result,
                summary="SNMPv3 service running.",
                overall_result="pass")
        else:
            result = dataclasses.replace(
                result,
                summary="SNMP running and is not v3")

    nmap.write_report(name, description, result)


def test_nmap_ports(nmap):
    name = 'security.nmap.ports'
    description = 'Ensure disallowed ports are not open'

    tcp_ports = nmap.get_ports_from_config(args.module_config, TCP, False)
    udp_ports = nmap.get_ports_from_config(args.module_config, UDP, False)

    if not tcp_ports and not udp_ports:
        tcp_result = nmap.test(protocol=TCP,ports=tcp_ports)
        udp_result = nmap.test(protocol=UDP,ports=udp_ports)

        combined_result = tcp_result.result or udp_result.result
        result = NmapTestResult(combined_result, tcp_result.ports + udp_result.ports, [])
    else:
        result = NmapTestResult(
            result=False,
            services=[],
            ports=[],
            overall_result='skip',
            summary='No servers defined in config')

    nmap.write_report(name, description, result)


if __name__ == "__main__":
    args = parse_command_line_args()
    nmap_results = NmapTest(args.report_file, args.nmap_xml)

    # Run the tests
    test_smtp(nmap_results)
    test_ftp(nmap_results)
    test_imap(nmap_results)
    test_pop(nmap_results)
    test_telnet(nmap_results)
    test_tftp(nmap_results)
    test_snmp(nmap_results)
    test_nmap_ports(nmap_results)

    # Done - any additional actions (e.g. putting output into
    # /tmp/report.txt or additional tests) are in the calling script test_nmap
