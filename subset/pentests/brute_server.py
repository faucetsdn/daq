import socket, sys

arguments = sys.argv

#address = '0.0.0.0'
address = str(arguments[1])

#port = 10000
port = int(arguments[2])

#simultaneousClients=1
simultaneous_clients = int(arguments[3])

data_length = 64

print 'address:' , address
print 'port:' , port
print 'clients:' , simultaneous_clients

username = 'manager'
password = 'friend'

request_msg = ['OFS1 login:','Password:','Last login:','Login incorrect','Connection closed by foreign host.']
flag = 0
enabled = 1
tries_count = 0

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_address = (address,port)

sock.bind(server_address)

sock.listen(simultaneous_clients)

while enabled:
    connection, client_address = sock.accept()
    try:
        connection.sendall(request_msg[0])

        while True:
            data = connection.recv(data_length)
            print data
            if data:
                if flag == 0:
                    user = data
                    connection.sendall(request_msg[1])
                    flag = 1
                elif flag == 1:
                    salt = data
                    if username == user and password == salt:
                        connection.sendall(request_msg[2])
                        flag = 2
                    else:
                        if tries_count == 2:
                            connection.sendall(request_msg[4])
                            break
                        else:
                            connection.sendall(request_msg[3])
                            tries_count = tries_count + 1
                            connection.sendall(request_msg[0])
                            flag = 0
            else:
                flag = 0
                break
    finally:
        enabled = 0
        connection.close()
